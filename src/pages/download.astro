---
import Layout from '../layouts/Layout.astro';
---

<Layout
  title="Download - Neon Injector"
  description="Download the latest version of Neon Injector for Mobile Legends skin injection. Compatible with all Android devices."
>
  <div class="flex flex-col min-h-screen">
    <main class="flex-1 pt-16">
      <section class="container mx-auto px-4 py-16 text-[var(--text-color)]">
        <h1 class="text-4xl font-bold text-neon-purple mb-8 text-center">Download Neon Injector</h1>
        <div class="max-w-2xl mx-auto prose">
          <p class="mb-4">Get the latest version of Neon Injector to start customizing your Mobile Legends skins. Our APK is lightweight, secure, and optimized for performance on all Android devices.</p>
          <div class="bg-[var(--card-bg)] p-6 rounded-lg shadow-lg border border-neon-purple-dark mb-8">
            <h2 class="text-2xl font-semibold mb-4">Latest Version: v1.3</h2>
            <p class="mb-4">This version includes improved injection speed, enhanced compatibility with Mobile Legends v1.7.0, and a redesigned skin preview interface.</p>
            
            <button
              id="download-btn"
              class="inline-block bg-neon-purple hover:bg-neon-purple-light text-white font-bold py-3 px-6 rounded-lg transition duration-300 cursor-pointer"
            >
              Download APK
            </button>

            <div id="download-progress-container" class="mt-4 hidden">
              <div class="w-full bg-[var(--card-bg)] rounded-full h-4 relative">
                <div 
                  id="progress-bar"
                  class="bg-neon-purple h-full rounded-full transition-all duration-300"
                  style="width: 0%;"
                ></div>
                <div id="progress-text" class="absolute inset-0 flex items-center justify-center text-sm text-white">0%</div>
              </div>
            </div>
            <p id="download-status" class="mt-2 text-sm hidden"></p>

            <p class="mt-4 text-sm">File Size: 4.5 MB | Updated: June 2025</p>
          </div>
          <h2 class="text-2xl font-semibold mb-4">System Requirements</h2>
          <ul class="list-disc list-inside space-y-2">
            <li>Android 7.0 (Nougat) or higher</li>
            <li>Minimum 2GB RAM for smooth performance</li>
            <li>Shizuku or SAF permissions for file access</li>
            <li>Mobile Legends v1.7.0 or newer installed</li>
            <li>At least 100MB free storage</li>
          </ul>
          <h2 class="text-2xl font-semibold mb-4 mt-8">Installation Guide</h2>
          <ol class="list-decimal list-inside space-y-2">
            <li>Click the "Download APK" button above to start downloading.</li>
            <li>Enable "Install from Unknown Sources" in your Android settings (Settings > Apps & Notifications > Special App Access > Install Unknown Apps).</li>
            <li>Open the downloaded APK and follow the on-screen instructions.</li>
            <li>Grant necessary permissions (SAF or Shizuku) during setup.</li>
            <li>Launch Neon Injector and start customizing!</li>
          </ol>
          <p class="mt-4 text-sm italic">Note: Ensure you download from our official site to avoid malicious versions.</p>
          <img src="/images/download-guide.webp" alt="Download Guide" class="w-full rounded-lg mt-8" loading="lazy" />
        </div>
      </section>
    </main>
  </div>

  <script>
    const downloadBtn = document.getElementById('download-btn');
    const progressBarContainer = document.getElementById('download-progress-container');
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    const downloadStatus = document.getElementById('download-status');

    downloadBtn.addEventListener('click', async () => {
      // Sembunyikan tombol dan tampilkan progress bar
      downloadBtn.disabled = true;
      downloadBtn.style.opacity = 0.5;
      progressBarContainer.classList.remove('hidden');
      downloadStatus.classList.remove('hidden');
      downloadStatus.textContent = 'Memulai unduhan...';

      const url = 'https://neoninjector.my.id/neon_injector_V_1.3.apk';
      const fileName = 'neon_injector_V_1.3.apk';
      
      try {
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }

        const contentLength = response.headers.get('Content-Length');
        const total = parseInt(contentLength, 10) || 0;
        let loaded = 0;
        const chunks = [];
        const reader = response.body.getReader();

        // Loop untuk membaca data secara bertahap (chunk)
        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          chunks.push(value);
          loaded += value.length;

          // Update progress bar
          const percentage = (loaded / total) * 100;
          progressBar.style.width = `${percentage}%`;
          progressText.textContent = `${percentage.toFixed(0)}%`;
          downloadStatus.textContent = `Mengunduh (${(loaded / 1048576).toFixed(2)} MB / ${(total / 1048576).toFixed(2)} MB)`;
        }

        // Setelah selesai, gabungkan chunk menjadi blob
        const blob = new Blob(chunks);
        downloadStatus.textContent = 'Unduhan selesai. Mempersiapkan file...';

        // Membuat link unduhan dan mengkliknya secara otomatis
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);

        downloadStatus.textContent = 'File berhasil diunduh!';
        
        // Atur ulang tampilan setelah beberapa detik
        setTimeout(() => {
          progressBarContainer.classList.add('hidden');
          downloadStatus.classList.add('hidden');
          progressBar.style.width = '0%';
          progressText.textContent = '0%';
          downloadBtn.disabled = false;
          downloadBtn.style.opacity = 1;
        }, 5000);
        
      } catch (error) {
        console.error('Download failed:', error);
        downloadStatus.textContent = 'Unduhan gagal. Silakan coba lagi.';
        
        // Atur ulang tampilan jika ada error
        setTimeout(() => {
          progressBarContainer.classList.add('hidden');
          downloadStatus.classList.add('hidden');
          downloadBtn.disabled = false;
          downloadBtn.style.opacity = 1;
        }, 5000);
      }
    });
  </script>
</Layout>
